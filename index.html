<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan World App - Prayer Times, Qibla, Quran</title>
    <meta name="description" content="An all-in-one Islamic app featuring accurate prayer times, Sehri and Iftar times, Qibla compass, Quran recitation, a dynamic Islamic calendar, Naat collection, and Tasbeeh counter. Your perfect companion for Ramadan and daily worship.">
    <meta name="keywords" content="islamic app, prayer times, qibla direction, quran online, ramadan 2025, sehri time, iftar time, islamic calendar, hijri date, naat, tasbeeh counter, ramadhan world, islamic history, salah times, listen quran, hadith, dua">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        h1, h2, h3, h4 {
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .prayer-time.active {
            background-color: rgba(50, 230, 0, 0.25);
            border-left-width: 4px;
            border-color: #32e600;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-button.active, .action-btn {
            background-color: #32e600;
            color: white;
            font-weight: 700;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.5);
            border-radius: 9999px;
        }
         .action-btn {
            border: none;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            height: 0;
            overflow: hidden;
            border-radius: 0.75rem;
            max-width: 960px;
            margin: auto;
        }
        .video-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        #compass {
            position: relative;
            width: 256px;
            height: 256px;
            background-color: #1f2937;
            border-radius: 9999px;
            border: 4px solid #374151;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 2rem auto;
        }
        .direction {
            position: absolute;
            font-weight: bold;
            color: #9ca3af;
        }
        .direction.north { top: 10px; font-size: 1.5rem; color: #ef4444; }
        .direction.south { bottom: 10px; }
        .direction.east { right: 10px; }
        .direction.west { left: 10px; }
        #qibla-line {
            position: absolute;
            width: 3px;
            height: 128px;
            background-color: #32e600;
            top: 0;
            left: 50%;
            transform-origin: bottom center;
            transition: transform 0.2s linear;
            box-shadow: 0 0 10px rgba(50, 230, 0, 0.7);
            z-index: 5;
        }
        .section-card {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 1rem;
            padding: 1.5rem;
            max-width: 48rem;
            margin-left: auto;
            margin-right: auto;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
        }
        .section-title {
            font-family: 'Cairo', sans-serif;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
        }
        .action-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(50, 230, 0, 0.7);
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.25rem;
        }
        .calendar-item {
            background-color: rgba(50, 230, 0, 0.1);
            border: 1px solid rgba(50, 230, 0, 0.2);
            border-radius: 0.75rem;
            padding: 1.25rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
        }
        .calendar-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25);
        }
        .calendar-date {
            font-family: 'Amiri', serif;
            font-size: 1.25rem;
            background-color: #32e600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-block;
            margin-bottom: 0.75rem;
        }
        .calendar-event-name {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .calendar-event-desc {
            font-size: 1rem;
            color: #d1d5db;
            flex-grow: 1;
        }
        .gregorian-date {
            font-size: 0.9rem;
            color: #9ca3af;
            margin-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 0.75rem;
        }
        #inbox-list {
            max-height: 70vh;
            overflow-y: auto;
        }
        .inbox-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #32e600;
            padding: 1rem;
            margin-bottom: 0.75rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .inbox-item.history {
            border-left-color: #f59e0b; /* Amber */
        }
        .inbox-item .timestamp {
            font-size: 0.8rem;
            color: #9ca3af;
        }
        .text-neon { color: #32e600; }
        .hover-bg-neon:hover { 
            background-color: #32e600; 
            color: white; 
            font-weight: 700; 
            text-shadow: 0 0 10px rgba(255,255,255,0.7); 
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.5); 
        }
        #countdown-timer {
            font-family: 'Amiri', serif;
            font-size: 4.5rem; 
            font-weight: 700; 
            letter-spacing: 0.05em;
            padding: 0.5rem 0;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.8), 0 0 20px #32e600, 0 0 35px #32e600, 0 0 50px #32e600, 0 0 70px #32e600;
        }
        #home-radio-section .card {
            box-shadow: 0 0 15px rgba(50, 230, 0, 0.4), 0 0 25px rgba(50, 230, 0, 0.2);
            border-color: rgba(50, 230, 0, 0.5);
        }
        #hadith-content p, #hadith-reference {
            font-size: 1.125rem;
            line-height: 1.75;
            color: #d1d5db;
        }
        #hadith-reference { color: #32e600; font-weight: 600; margin-top: 1rem; }
        .dua-form label {
            font-weight: 600; display: block; margin-top: 1rem; margin-bottom: 0.5rem; text-align: left;
        }
        .dua-form input, .dua-form textarea {
            width: 100%; background-color: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            padding: 0.75rem; border-radius: 0.5rem; color: white;
        }
        .dua-list {
            margin-top: 1.5rem; max-height: 400px; overflow-y: auto; padding-right: 10px;
        }
        .dua-item {
            background-color: rgba(255,255,255,0.05); padding: 1rem; border-radius: 0.75rem; margin-bottom: 1rem;
            border-left: 4px solid #32e600; text-align: left;
        }
        .dua-item small { color: #9ca3af; font-size: 0.8rem; }
        
        audio::-webkit-media-controls-panel { background-color: #374151; }
        audio::-webkit-media-controls-play-button,
        audio::-webkit-media-controls-current-time-display,
        audio::-webkit-media-controls-time-remaining-display,
        audio::-webkit-media-controls-mute-button { color: #32e600; border-radius: 9999px; }
        audio::-webkit-media-controls-timeline,
        audio::-webkit-media-controls-volume-slider { background-color: rgba(50, 230, 0, 0.2); border-radius: 9999px; margin: 0 10px; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50 transition-opacity duration-500">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-neon"></div>
        <p class="mt-4 text-lg">Loading App...</p>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <p id="location" class="text-md text-gray-400 mt-1">Fetching location...</p>
            <p id="coords-display" class="text-xs text-gray-500 mt-1 hidden">Lat: --, Lon: --</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Quran</button>
            <button onclick="showView('dua')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Request a Dua</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Qibla</button>
            <button onclick="showView('calendar')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Calendar</button>
            <button onclick="showView('inbox')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Inbox</button>
            <button onclick="showView('settings')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 hover-bg-neon transition">Settings</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="text-2xl mb-2">Time until <span id="next-prayer-name" class="text-neon">...</span></h2>
                        <div id="countdown-timer" class="text-neon">00:00:00</div>
                    </div>
                </section>
                
                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 class="section-title" style="font-size: 1.5rem; margin-bottom: 1rem;">üìª PRESS TO PLAY LIVE RADIO</h2>
                        <audio id="radioPlayer" controls controlslist="nodownload" class="w-full rounded-lg" preload="auto">
                            <source src="https://ramadhan786.radioca.st/;" type="audio/mpeg" />
                        </audio>
                    </div>
                </section>

                <section id="hadith-section" class="mb-8">
                    <div class="section-card">
                        <h2 class="section-title">üìú Today's Hadith</h2>
                        <div id="hadith-content" class="text-center">
                            <p class="font-amiri text-lg">Loading a Hadith...</p>
                            <p id="hadith-reference" class="text-neon mt-4 font-semibold"></p>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Today's Times</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="salah-fajr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Fajr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-sunrise" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Sunrise</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-dhuhr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Dhuhr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-asr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Asr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-maghrib" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Maghrib</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-isha" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Isha</span><span class="text-xl font-mono">--:--</span></div>
                    </div>
                    <hr class="border-gray-600 my-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="salah-sehri" class="card rounded-xl p-4 flex justify-between items-center border-l-4" style="background-color: rgba(50, 230, 0, 0.2); border-color: #32e600;">
                            <span class="font-semibold text-lg">Sehri End</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                        <div id="salah-iftar" class="card rounded-xl p-4 flex justify-between items-center bg-yellow-800 border-l-4 border-yellow-400">
                            <span class="font-semibold text-lg">Iftar</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listen-quran-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="text-2xl mb-4 text-center">Holy Quran Recitation</h2>
                    <p class="text-center text-gray-400 mb-4">Recitation by Abdurrahman As-Sudais</p>
                    <div id="quran-player" class="text-center hidden">
                        <h3 id="current-surah-name" class="text-xl mb-2 text-neon"></h3>
                        <audio id="quran-audio-player" controls controlslist="nodownload" class="w-full rounded-lg"></audio>
                    </div>
                    <div id="quran-loading-indicator" class="text-center py-8 hidden">
                        <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                        <p class="mt-4 text-lg">Loading Surahs...</p>
                    </div>
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2"></div>
                </div>
            </div>

            <!-- Dua View -->
            <div id="dua-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">ü§≤ Request a Dua</h2>
                     <form id="dua-form" class="dua-form">
                        <label for="dua-name">Name for Dua</label>
                        <input type="text" id="dua-name" placeholder="e.g., My Father" required>
                        
                        <label for="dua-relation">Your Relation</label>
                        <input type="text" id="dua-relation" placeholder="e.g., Son" required>
                        
                        <label for="dua-text">Write your Dua</label>
                        <textarea id="dua-text" rows="4" placeholder="May Allah grant him peace and good health..." required></textarea>
                        
                        <button type="submit" class="action-btn w-full mt-6 py-3">Submit Dua</button>
                    </form>
                    <div class="dua-list mt-6">
                        <h3 class="text-xl text-center mb-4 border-b border-gray-700 pb-2">Community Dua List</h3>
                        <div id="dua-list-container"></div>
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-neon mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-neon text-white text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95" style="box-shadow: 0 0 20px rgba(50, 230, 0, 0.6);"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="bg-neon py-2 px-4 rounded-full text-lg"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div class="direction north">N</div>
                        <div class="direction south">S</div>
                        <div class="direction east">E</div>
                        <div class="direction west">W</div>
                        <div id="qibla-line"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                    <p class="text-lg text-yellow-400 mt-4">THIS FEATURE IS COMING SOON</p>
                    <p class="text-sm text-gray-400 mt-2">(Accuracy depends on your device's hardware and browser support)</p>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="hidden">
                <section id="islamic-calendar-section">
                     <div class="section-card">
                        <h2 class="section-title">üóìÔ∏è Major Islamic Events</h2>
                        <div id="calendar-loading-indicator" class="text-center py-8">
                            <div class="animate-spin rounded-full h-12 w-12 border-t-4 border-b-4 border-neon mx-auto"></div>
                            <p class="mt-4 text-lg">Fetching live dates...</p>
                        </div>
                        <div id="islamic-calendar-grid" class="calendar-grid">
                            <!-- Events will be populated here by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Inbox View -->
            <div id="inbox-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">üì• Inbox</h2>
                    <div id="inbox-list">
                        <p class="text-center text-gray-400">No notifications yet.</p>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-lg mx-auto">
                    <h2 class="text-2xl mb-4">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg mb-2">Master Notification Control</h3>
                            <button id="settings-notification-toggle" onclick="toggleMasterNotifications()" class="w-full py-2 px-4 rounded-lg transition-colors">Toggle Notifications</button>
                        </div>
                        <hr class="border-gray-600">
                        <div>
                            <h3 class="text-lg mb-2">Manage Inbox</h3>
                             <button onclick="clearInboxHistory()" class="w-full py-2 px-4 rounded-lg bg-red-600 hover:bg-red-700 transition-colors">Clear Inbox History</button>
                        </div>
                    </div>
                    <button onclick="saveSettings()" class="mt-6 w-full action-btn py-3 rounded-lg transition">Save Settings</button>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center mt-12 text-gray-500 text-sm">
            <p>Contact us: radioramadhanworld@gmail.com</p>
            <p>Powered by RAMADHAN WORLD PRODUCTION</p>
        </footer>
    </div>

    <audio id="azan-fajr-audio" src="fajr.mp3" preload="auto"></audio>
    <audio id="azan-other-audio" src="other salah.mp3" preload="auto"></audio>
    <audio id="sms-tune-audio" src="data:audio/mpeg;base64,UklGRl9vT19XQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YU9vT19OaWNlIGZlZWwgYmVhdCBvZiB0aGUgbW9kZXJuIHdvcmxkLiBDb250YWN0IG1lIGF0ICtrZDUyNjU2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NkZWZpbml0ZWx5IG5vdCBhIHZpcnVz" preload="auto"></audio>
    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const coordsDisplayEl = document.getElementById('coords-display'); // New element for coordinates
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const salahPrayerTimeElements = { Fajr: document.querySelector('#salah-fajr span:last-child'), Sunrise: document.querySelector('#salah-sunrise span:last-child'), Dhuhr: document.querySelector('#salah-dhuhr span:last-child'), Asr: document.querySelector('#salah-asr span:last-child'), Maghrib: document.querySelector('#salah-maghrib span:last-child'), Isha: document.querySelector('#salah-isha span:last-child') };
        const views = { home: document.getElementById('home-view'), salah: document.getElementById('salah-view'), listenQuran: document.getElementById('listen-quran-view'), dua: document.getElementById('dua-view'), qibla: document.getElementById('qibla-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), calendar: document.getElementById('calendar-view'), inbox: document.getElementById('inbox-view'), settings: document.getElementById('settings-view') };
        const qiblaDirectionEl = document.getElementById('qibla-direction');
        const qiblaLine = document.getElementById('qibla-line');
        const radioPlayer = document.getElementById('radioPlayer');
        const azanFajrAudio = document.getElementById('azan-fajr-audio');
        const azanOtherAudio = document.getElementById('azan-other-audio');
        const smsTuneAudio = document.getElementById('sms-tune-audio');
        const settingsSavedMessage = document.getElementById('settings-saved-message');
        const tvPlayButton = document.getElementById('tv-play-button');
        const tvPauseButton = document.getElementById('tv-pause-button');
        const tasbeehCounterDisplay = document.getElementById('tasbeeh-counter-display');
        const settingsNotificationToggle = document.getElementById('settings-notification-toggle');
        const inboxList = document.getElementById('inbox-list');
        const hadithContentEl = document.getElementById('hadith-content');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranLoadingIndicator = document.getElementById('quran-loading-indicator');
        const quranPlayer = document.getElementById('quran-player');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const duaListContainer = document.getElementById('dua-list-container');
        const duaForm = document.getElementById('dua-form');

        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let settings = {};
        let notificationsEnabled = true;
        let youtubePlayer;
        let userCoords = null; // Stores {latitude, longitude}
        let notificationLog = [];
        let audioUnlocked = false;
        let intendedAudioSource = null;
        let quranChapters = [];
        let quranListLoaded = false;
        let duaList = [];
        let currentPlayingQuran = { element: null, surahId: null, index: -1 };

        const NOTIFICATION_STATUS_KEY = 'ramadanAppNotificationStatus';
        const NOTIFICATION_LOG_KEY = 'ramadanAppNotificationLog';
        const HADITH_CACHE_KEY = 'ramadanAppHadithCache';
        const DUA_LIST_KEY = 'ramadanAppDuaList';
        
        const islamicEvents = [
            { hijriDate: '01-01', date: "1 Muharram", name: "Islamic New Year", description: "The start of the Islamic lunar calendar." },
            { hijriDate: '10-01', date: "10 Muharram", name: "Day of Ashura", description: "A day of fasting and remembrance." },
            { hijriDate: '12-03', date: "12 Rabi al-Awwal", name: "Mawlid an-Nabi", description: "The birthday of Prophet Muhammad Ô∑∫." },
            { hijriDate: '27-07', date: "27 Rajab", name: "Isra and Mi'raj", description: "The Prophet's Ô∑∫ miraculous night journey." },
            { hijriDate: '15-08', date: "15 Sha‚Äôban", name: "Laylat al-Bara'at", description: "The night of forgiveness." },
            { hijriDate: '01-09', date: "1 Ramadan", name: "Start of Ramadan", description: "The beginning of the holy month of fasting." },
            { hijriDate: '27-09', date: "27 Ramadan", name: "Laylat al-Qadr", description: "The Night of Power, better than a thousand months." },
            { hijriDate: '01-10', date: "1 Shawwal", name: "Eid al-Fitr", description: "The festival of breaking the fast." },
            { hijriDate: '09-12', date: "9 Dhul Hijjah", name: "Day of Arafah", description: "The pinnacle of the annual Hajj pilgrimage." },
            { hijriDate: '10-12', date: "10 Dhul Hijjah", name: "Eid al-Adha", description: "The festival of sacrifice." }
        ];

        function manageAudioPlayback(source) {
            if (source !== 'radio' && radioPlayer && !radioPlayer.paused) { radioPlayer.pause(); }
            if (source !== 'quran' && quranAudioPlayer && !quranAudioPlayer.paused) { quranAudioPlayer.pause(); }
            if (source !== 'naat' && youtubePlayer && typeof youtubePlayer.pauseVideo === 'function' && youtubePlayer.getPlayerState() === 1) { youtubePlayer.pauseVideo(); }
            intendedAudioSource = source;
        }

        async function initializeApp() {
            // Show the page immediately
            hideLoading();
            
            // Load all settings and stored data
            document.body.addEventListener('click', unlockAllAudio, { once: true });
            loadSettings();
            loadNotificationStatus();
            loadNotificationLog();
            displayNotificationsInInbox();
            loadTasbeehCount();
            loadDuas();
            setupRadioPlayer();
            
            // Fetch location and hadith data in the background
            await getUserLocation(); // This now handles both geolocation and IP fallback
            await fetchHadith();
        }

        function unlockAllAudio() {
            if (audioUnlocked) return;
            [azanFajrAudio, azanOtherAudio, smsTuneAudio, quranAudioPlayer, radioPlayer].forEach(audio => {
                if (audio) {
                    audio.muted = true;
                    const playPromise = audio.play();
                    if(playPromise !== undefined){
                        playPromise.then(() => { audio.pause(); audio.currentTime = 0; audio.muted = false; }).catch(() => {});
                    }
                }
            });
            audioUnlocked = true;
        }

        async function fetchHadith() {
            try {
                const cachedData = JSON.parse(localStorage.getItem(HADITH_CACHE_KEY));
                const sixHours = 6 * 60 * 60 * 1000;
                if (cachedData && (Date.now() - cachedData.timestamp < sixHours)) {
                    displayHadith(cachedData.hadith);
                    return;
                }
                const response = await fetch("https://random-hadith-generator.vercel.app/bukhari/");
                if (!response.ok) throw new Error('Failed to fetch Hadith');
                const data = await response.json();
                const hadith = data.data;
                displayHadith(hadith);
                localStorage.setItem(HADITH_CACHE_KEY, JSON.stringify({ hadith: hadith, timestamp: Date.now() }));
            } catch (error) {
                console.error("Hadith fetch error:", error);
                const fallbackHadith = { hadith_english: "The best among you are those who have the best manners and character.", book: "Sahih al-Bukhari", refno: "3559" };
                displayHadith(fallbackHadith);
            }
        }
        
        function displayHadith(hadith) {
            hadithContentEl.innerHTML = `<p class="font-amiri text-lg">${hadith.hadith_english}</p><p id="hadith-reference" class="text-neon mt-4 font-semibold">Reference: ${hadith.book} ${hadith.refno}</p>`;
        }
        
        async function populateEventCalendar(hijriYear) {
            const grid = document.getElementById('islamic-calendar-grid');
            const loadingIndicator = document.getElementById('calendar-loading-indicator');
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const apiCalls = islamicEvents.map(event => fetch(`https://api.aladhan.com/v1/hToG?date=${event.hijriDate}-${hijriYear}`).then(res => res.json()));
            try {
                const results = await Promise.all(apiCalls);
                const eventsHtml = results.map((result, index) => {
                    if (result.code === 200) {
                        const gregDate = result.data.gregorian;
                        const eventDate = new Date(`${gregDate.month.en} ${gregDate.day}, ${gregDate.year}`);
                        if (eventDate >= today) {
                            const fullDisplayDate = eventDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
                            return `<div class="calendar-item">
                                        <div class="calendar-date">${islamicEvents[index].date}</div>
                                        <h3 class="calendar-event-name">${islamicEvents[index].name}</h3>
                                        <p class="calendar-event-desc">${islamicEvents[index].description}</p>
                                        <div class="gregorian-date"><strong>Expected Gregorian Date (${gregDate.year}):</strong><br>${fullDisplayDate}</div>
                                    </div>`;
                        }
                    }
                    return '';
                }).join('');
                grid.innerHTML = eventsHtml.trim() ? eventsHtml : `<p class="text-center text-gray-400 col-span-full">No upcoming major events found.</p>`;
                loadingIndicator.style.display = 'none';
            } catch (error) {
                loadingIndicator.innerHTML = `<p class="text-red-400">Could not load live calendar dates.</p>`;
            }
        }
        
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = 21.4225, kaabaLon = 39.8262;
            const dLon = (kaabaLon - userLon) * (Math.PI / 180);
            const lat1 = userLat * (Math.PI / 180), lat2 = kaabaLat * (Math.PI / 180);
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            return (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
        }

        /**
         * Attempts to get user's location using Geolocation API first.
         * If denied or unavailable, falls back to IP-based geolocation.
         */
        async function getUserLocation() {
            locationEl.textContent = "Fetching location...";
            coordsDisplayEl.classList.add('hidden'); // Hide coordinates until fetched

            if (navigator.geolocation) {
                try {
                    const position = await new Promise((resolve, reject) => {
                        navigator.geolocation.getCurrentPosition(resolve, reject, { timeout: 8000 });
                    });
                    userCoords = { latitude: position.coords.latitude, longitude: position.coords.longitude };
                    qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                    coordsDisplayEl.textContent = `Lat: ${userCoords.latitude.toFixed(4)}, Lon: ${userCoords.longitude.toFixed(4)}`;
                    coordsDisplayEl.classList.remove('hidden');

                    try {
                        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
                        const data = await response.json();
                        const city = data.address.city || data.address.town || 'Unknown City';
                        const country = data.address.country || 'Unknown Country';
                        locationEl.textContent = `${city}, ${country}`;
                        const prayerData = await getPrayerTimes(city, country, userCoords.latitude, userCoords.longitude);
                        if (prayerData) updateCountdown(prayerData.timings);
                    } catch (error) {
                        console.error("Reverse geocoding failed, using coordinates directly:", error);
                        locationEl.textContent = `Location (Lat: ${userCoords.latitude.toFixed(2)}, Lon: ${userCoords.longitude.toFixed(2)})`;
                        const prayerData = await getPrayerTimes(null, null, userCoords.latitude, userCoords.longitude); // Pass coords directly
                        if (prayerData) updateCountdown(prayerData.timings);
                    }
                } catch (error) {
                    console.warn(`Geolocation error (${error.code}): ${error.message}. Falling back to IP.`);
                    await getLocationByIp();
                }
            } else {
                console.warn("Geolocation not supported by this browser. Falling back to IP.");
                await getLocationByIp();
            }
        }

        /**
         * Gets user's approximate location using IP address.
         */
        async function getLocationByIp() {
            locationEl.textContent = "Estimating location from network...";
            coordsDisplayEl.classList.add('hidden');
            try {
                // Using ipwhois.app as a more reliable alternative for IP geolocation
                const response = await fetch('https://ipwhois.app/json/'); 
                
                if (!response.ok) {
                    console.error(`IP API response not OK: ${response.status} ${response.statusText}`);
                    throw new Error(`IP API response not OK: ${response.status} ${response.statusText}`);
                }
                const data = await response.json();
                
                // Check for success status and expected fields from ipwhois.app
                if (data.success && data.latitude && data.longitude) {
                    const { city, country, latitude, longitude } = data;
                    userCoords = { latitude: latitude, longitude: longitude };
                    qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                    locationEl.textContent = `${city || 'Unknown City'}, ${country || 'Unknown Country'}`;
                    coordsDisplayEl.textContent = `Lat: ${latitude.toFixed(4)}, Lon: ${longitude.toFixed(4)}`;
                    coordsDisplayEl.classList.remove('hidden');
                    const prayerData = await getPrayerTimes(city, country, latitude, longitude);
                    if (prayerData) updateCountdown(prayerData.timings);
                } else {
                    console.error(`IP API returned failure status or unexpected data structure:`, data);
                    throw new Error(`IP API returned failure status or unexpected data structure: ${data.message || 'Unknown error'}`);
                }
            } catch (error) {
                console.error("IP Geolocation failed:", error);
                locationEl.textContent = "Could not determine location. Using default (Karachi, Pakistan).";
                userCoords = { latitude: 24.8607, longitude: 67.0011 }; // Default to Karachi
                qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);
                coordsDisplayEl.textContent = `Lat: ${userCoords.latitude.toFixed(4)}, Lon: ${userCoords.longitude.toFixed(4)}`;
                coordsDisplayEl.classList.remove('hidden');
                const prayerData = await getPrayerTimes("Karachi", "Pakistan", userCoords.latitude, userCoords.longitude);
                if (prayerData) updateCountdown(prayerData.timings);
            }
        }

        /**
         * Fetches prayer times using city/country or latitude/longitude.
         * Prioritizes lat/lon if provided.
         */
        async function getPrayerTimes(city, country, lat = null, lon = null) {
            try {
                const date = new Date(), dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                let apiUrl;
                if (lat !== null && lon !== null) {
                    // Use coordinates if available for more accurate results
                    apiUrl = `https://api.aladhan.com/v1/timings/${dateString}?latitude=${lat}&longitude=${lon}&method=2`;
                } else if (city && country) {
                    // Fallback to city/country if coordinates are not available
                    apiUrl = `https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${city}&country=${country}&method=2`;
                } else {
                    console.error("Insufficient location information to fetch prayer times. Using default.");
                    // Fallback to a hardcoded default if no location info is available
                    lat = 24.8607; // Karachi latitude
                    lon = 67.0011; // Karachi longitude
                    apiUrl = `https://api.aladhan.com/v1/timings/${dateString}?latitude=${lat}&longitude=${lon}&method=2`;
                }

                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    populateEventCalendar(data.data.date.hijri.year);
                    return data.data;
                }
                return null;
            } catch (error) { console.error("Error fetching prayer times:", error); return null; }
        }

        function subtractMinutes(timeStr, minutes) {
            const [h, m] = timeStr.split(':').map(Number);
            const time = new Date(); time.setHours(h, m - minutes, 0, 0);
            return `${padZero(time.getHours())}:${padZero(time.getMinutes())}`;
        }

        function displayPrayerTimes(data) {
            const { timings, date } = data;
            islamicDateEl.textContent = `${date.hijri.weekday.en}, ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            Object.keys(salahPrayerTimeElements).forEach(p => { if (salahPrayerTimeElements[p] && timings[p]) salahPrayerTimeElements[p].textContent = formatTime(timings[p]); });
            document.querySelector('#salah-sehri span:last-child').textContent = formatTime(subtractMinutes(timings.Fajr, 10));
            document.querySelector('#salah-iftar span:last-child').textContent = formatTime(timings.Maghrib);
        }
        
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            let nextPrayerTriggered = false;
            countdownInterval = setInterval(() => {
                const now = new Date();
                const nextPrayer = findNextPrayer(now, timings);
                if (nextPrayer) {
                    if (nextPrayer.name !== nextPrayerNameEl.textContent) nextPrayerTriggered = false;
                    nextPrayerNameEl.textContent = nextPrayer.name;
                    const diff = new Date(`${now.toDateString()} ${nextPrayer.time}`).getTime() - now.getTime();
                    if (diff > 0) {
                        const h = Math.floor(diff / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
                        countdownTimerEl.textContent = `${padZero(h)}:${padZero(m)}:${padZero(s)}`;
                        if (diff <= 1000 && !nextPrayerTriggered) { triggerPrayerNotification(nextPrayer.name); nextPrayerTriggered = true; }
                    } else { getUserLocation(); } // Re-fetch location/prayer times on day change
                } else { nextPrayerNameEl.textContent = 'Day Complete'; countdownTimerEl.textContent = '00:00:00'; }
            }, 1000);
        }

        function findNextPrayer(now, timings) {
            for (const prayerName of ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']) {
                if (timings[prayerName]) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) return { name: prayerName, time: timings[prayerName] };
                }
            }
            return null;
        }

        function showView(viewName) {
            manageAudioPlayback(null);
            if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') { youtubePlayer.pauseVideo(); }
            
            Object.values(views).forEach(v => v.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(b => b.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`)?.classList.add('active');

            if (viewName === 'listenQuran' && !quranListLoaded) populateQuranList();
            if (viewName === 'qibla') startCompass(); else stopCompass();
        }

        function hideLoading() {
            loadingScreen.classList.add('opacity-0');
            setTimeout(() => { 
                loadingScreen.style.display = 'none'; 
                mainContent.classList.remove('opacity-0'); 
            }, 500);
        }

        function startCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(p => { if (p === 'granted') window.addEventListener('deviceorientation', handleOrientation); }).catch(console.error);
            } else window.addEventListener('deviceorientation', handleOrientation);
        }
        function stopCompass() { window.removeEventListener('deviceorientation', handleOrientation); }
        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if (alpha !== null) qiblaLine.style.transform = `translateX(-50%) rotate(${qiblaAngle - alpha}deg)`;
        }

        async function populateQuranList() {
            if (quranListLoaded) return;
            quranLoadingIndicator.classList.remove('hidden');
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((s, i) => `
                    <div id="surah-item-${s.id}" class="quran-surah cursor-pointer p-3 rounded-lg flex justify-between items-center bg-gray-800 hover:bg-gray-700 transition" onclick="playSurah(${s.id}, '${s.name_simple.replace(/'/g, "\\'")}', this, ${i})">
                        <div><p class="font-semibold">${s.id}. ${s.name_simple}</p><p class="text-sm text-gray-400">${s.translated_name.name}</p></div>
                        <div><i class="fas fa-play text-neon play-icon"></i><i class="fas fa-pause text-neon pause-icon hidden"></i></div>
                    </div>`).join('');
                quranListLoaded = true;
            } catch (e) { 
                quranSurahList.innerHTML = `<p class="text-center text-red-400 col-span-full">Could not load Surahs.</p>`; 
            } finally { 
                quranLoadingIndicator.style.display = 'none';
            }
        }
        
        function resetQuranItemUI(element) {
            if (element) {
                const playIcon = element.querySelector('.play-icon');
                const pauseIcon = element.querySelector('.pause-icon');
                if (playIcon && pauseIcon) {
                    playIcon.classList.remove('hidden');
                    pauseIcon.classList.add('hidden');
                }
            }
        }
        
        async function playSurah(surahId, surahName, element, index) {
            if (currentPlayingQuran.surahId === surahId) {
                if (quranAudioPlayer.paused) { quranAudioPlayer.play(); } else { quranAudioPlayer.pause(); }
                return;
            }
            if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); }
            manageAudioPlayback('quran');
            currentSurahName.textContent = `Loading ${surahName}...`;
            quranPlayer.classList.remove('hidden');
            try {
                const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`);
                if (!response.ok) throw new Error(`API request failed`);
                const data = await response.json();
                if (!data.audio_file || !data.audio_file.audio_url) { throw new Error(`Audio not available`); }
                quranAudioPlayer.src = data.audio_file.audio_url;
                quranAudioPlayer.muted = false;
                quranAudioPlayer.volume = 1.0;
                await quranAudioPlayer.play();
                currentSurahName.textContent = surahName;
                currentPlayingQuran = { element, surahId, index };
            } catch (error) {
                currentSurahName.textContent = `Error: ${error.message} for ${surahName}`; 
                resetQuranItemUI(element);
                currentPlayingQuran = { element: null, surahId: null, index: -1 };
            }
        }

        quranAudioPlayer.addEventListener('play', () => {
            if (currentPlayingQuran.element) {
                currentPlayingQuran.element.querySelector('.play-icon').classList.add('hidden');
                currentPlayingQuran.element.querySelector('.pause-icon').classList.remove('hidden');
            }
        });
        quranAudioPlayer.addEventListener('pause', () => { if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); } });
        quranAudioPlayer.onended = () => {
            if (currentPlayingQuran.element) { resetQuranItemUI(currentPlayingQuran.element); }
            const nextIndex = currentPlayingQuran.index + 1;
            if (nextIndex < quranChapters.length) {
                const nextSurah = quranChapters[nextIndex];
                const nextElement = document.getElementById(`surah-item-${nextSurah.id}`);
                playSurah(nextSurah.id, nextSurah.name_simple, nextElement, nextIndex);
            } else {
                currentPlayingQuran = { element: null, surahId: null, index: -1 };
                currentSurahName.textContent = "Finished Recitation";
            }
        };

        function setupRadioPlayer() { radioPlayer.addEventListener('play', () => manageAudioPlayback('radio')); }
        
        function incrementTasbeeh() { tasbeehCounterDisplay.textContent = ++tasbeehCount; saveTasbeehCount(); }
        function resetTasbeeh() { tasbeehCounterDisplay.textContent = tasbeehCount = 0; saveTasbeehCount(); }
        function saveTasbeehCount() { localStorage.setItem('ramadanTasbeeh', tasbeehCount); }
        function loadTasbeehCount() { tasbeehCount = localStorage.getItem('ramadanTasbeeh') || 0; tasbeehCounterDisplay.textContent = tasbeehCount; }

        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', { height: '480', width: '854', playerVars: { 'playsinline': 1, 'listType': 'playlist', 'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', 'controls': 0, 'rel': 0 }, events: { 'onStateChange': onPlayerStateChange } });
        }
        
        function onPlayerStateChange(event) {
            tvPlayButton.classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            tvPauseButton.classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
            if(event.data === YT.PlayerState.PLAYING) manageAudioPlayback('naat');
        }
        
        function playVideo() { manageAudioPlayback('naat'); youtubePlayer.playVideo(); }
        function pauseVideo() { youtubePlayer.pauseVideo(); intendedAudioSource = null; }
        function nextVideo() { youtubePlayer.nextVideo(); }
        function previousVideo() { youtubePlayer.previousVideo(); }

        function loadDuas() {
            duaList = JSON.parse(localStorage.getItem(DUA_LIST_KEY) || '[]');
            displayDuas();
        }

        function displayDuas() {
            if (!duaListContainer) return;
            if (duaList.length === 0) {
                duaListContainer.innerHTML = `<p class="text-center text-gray-400">No duas yet. Be the first!</p>`;
                return;
            }
            duaListContainer.innerHTML = duaList
                .map(dua => `<div class="dua-item"><p class="font-bold text-white">${escapeHTML(dua.name)} <span class="font-normal text-gray-300">(${escapeHTML(dua.relation)})</span></p><p class="text-gray-200 my-2">${escapeHTML(dua.text)}</p><small>Submitted: ${new Date(dua.timestamp).toLocaleString()}</small></div>`).join('');
        }
        
        function escapeHTML(str) {
            return str.replace(/[&<>"']/g, function(match) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[match];
            });
        }
        
        duaForm.addEventListener('submit', function(e){
            e.preventDefault();
            const nameEl = document.getElementById('dua-name');
            const relationEl = document.getElementById('dua-relation');
            const textEl = document.getElementById('dua-text');
            const text = textEl.value.trim();

            if (text.length < 10) {
                showTemporaryMessage('Dua is too short. Please write a meaningful request.', true);
                return;
            }
            
            const forbiddenWords = ['badword', 'profanity', 'inappropriate', 'test', 'kill'];
            const filterPattern = new RegExp(forbiddenWords.join('|'), 'i');
            if (filterPattern.test(text)) {
                showTemporaryMessage('Dua contains inappropriate content and cannot be submitted.', true);
                return;
            }

            const newDua = { name: nameEl.value, relation: relationEl.value, text: text, timestamp: new Date().toISOString() };
            duaList.unshift(newDua);
            localStorage.setItem(DUA_LIST_KEY, JSON.stringify(duaList));
            displayDuas();
            nameEl.value = '';
            relationEl.value = '';
            textEl.value = '';
            showTemporaryMessage('Your dua has been submitted for the community!', false);
        });

        function updateSettingsNotificationUI() {
            if (notificationsEnabled) {
                settingsNotificationToggle.textContent = 'Notifications are ON';
                settingsNotificationToggle.classList.add('bg-green-600', 'hover:bg-green-700');
                settingsNotificationToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
            } else {
                settingsNotificationToggle.textContent = 'Notifications are OFF';
                settingsNotificationToggle.classList.add('bg-red-600', 'hover:bg-red-700');
                settingsNotificationToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
            }
        }

        function saveNotificationStatus() { localStorage.setItem(NOTIFICATION_STATUS_KEY, notificationsEnabled); }
        function loadNotificationStatus() { notificationsEnabled = localStorage.getItem(NOTIFICATION_STATUS_KEY) !== 'false'; updateSettingsNotificationUI(); }

        function toggleMasterNotifications() {
            if (Notification.permission === 'denied') return showTemporaryMessage('Notifications are blocked by your browser.', true);
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(p => { if (p === 'granted') { notificationsEnabled = !notificationsEnabled; saveNotificationStatus(); updateSettingsNotificationUI(); } });
            } else { notificationsEnabled = !notificationsEnabled; saveNotificationStatus(); updateSettingsNotificationUI(); }
        }

        function logNotification(message, type) {
            notificationLog.unshift({ message, type, timestamp: new Date().toISOString() });
            pruneNotificationLog();
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
            displayNotificationsInInbox();
        }

        function loadNotificationLog() { notificationLog = JSON.parse(localStorage.getItem(NOTIFICATION_LOG_KEY) || '[]'); pruneNotificationLog(); }
        function pruneNotificationLog() {
            const twoDaysAgo = new Date(); twoDaysAgo.setDate(twoDaysAgo.getDate() - 2);
            notificationLog = notificationLog.filter(i => new Date(i.timestamp) > twoDaysAgo);
            localStorage.setItem(NOTIFICATION_LOG_KEY, JSON.stringify(notificationLog));
        }
        
        function displayNotificationsInInbox() {
            if (notificationLog.length === 0) return inboxList.innerHTML = `<p class="text-center text-gray-400">No notifications in the last 48 hours.</p>`;
            inboxList.innerHTML = notificationLog.map(i => `<div class="inbox-item ${i.type==='history' ? 'history' : ''}"><p>${i.message}</p><p class="timestamp">${new Date(i.timestamp).toLocaleDateString()} at ${new Date(i.timestamp).toLocaleTimeString()}</p></div>`).join('');
        }

        function clearInboxHistory() { notificationLog = []; localStorage.removeItem(NOTIFICATION_LOG_KEY); displayNotificationsInInbox(); showTemporaryMessage('Inbox history has been cleared.'); }

        function sendNotification(message, type) {
             if (!notificationsEnabled) return;
             logNotification(message, type);
             if (Notification.permission === "granted") new Notification(message);
        }
        
        function triggerPrayerNotification(prayerName) {
            if (!notificationsEnabled) return;
            sendNotification(`It's time for ${prayerName} prayer!`, 'salah');
            const audio = prayerName === 'Fajr' ? azanFajrAudio : azanOtherAudio;
            if (audio) audio.play().catch(e => showTemporaryMessage('Azan blocked by browser.', true));
        }

        function saveSettings() { localStorage.setItem('ramadanAppSettings', JSON.stringify(settings)); showTemporaryMessage('Settings Saved!'); }
        function loadSettings() { const s = localStorage.getItem('ramadanAppSettings'); if (s) settings = JSON.parse(s); }
        
        function showTemporaryMessage(message, isError = false) {
            settingsSavedMessage.textContent = message;
            settingsSavedMessage.style.backgroundColor = isError ? '#ef4444' : '#10B981';
            settingsSavedMessage.classList.remove('opacity-0');
            setTimeout(() => { settingsSavedMessage.classList.add('opacity-0'); }, 4000);
        }

        function formatTime(time24) {
            const [h, m] = time24.split(':');
            const hour = parseInt(h, 10);
            return `${padZero(hour % 12 || 12)}:${m} ${hour >= 12 ? 'PM' : 'AM'}`;
        }
        function padZero(num) { return num < 10 ? '0' + num : String(num); }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
