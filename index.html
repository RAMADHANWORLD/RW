<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ramadhan World App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Cairo', 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-amiri {
            font-family: 'Amiri', serif;
        }
        .card {
            background-color: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        /* Neon Green Theme Updates */
        #countdown-heading {
            font-weight: 700;
            color: #ffffff;
            text-shadow: 0 0 4px #39FF14, 0 0 8px #39FF14;
        }
        #countdown-timer {
            font-weight: 700; /* Bold */
            font-size: 4.5rem; /* Larger */
            color: #ffffff; /* White text */
            text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14, 0 0 20px #39FF14, 0 0 30px #39FF14; /* Glowing green shadow */
            letter-spacing: 0.05em;
        }
        #next-prayer-name {
            color: #39FF14;
            font-weight: 700; /* Bold */
        }
        .prayer-time.active {
            background-color: rgba(57, 255, 20, 0.2);
            border-left-width: 4px;
            border-color: #39FF14;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }
        .nav-button.active {
            background-color: #39FF14;
            color: #000;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        .nav-button:hover {
            background-color: #39FF14;
            color: #000;
        }
        #qibla-line {
            background-color: #39FF14;
            box-shadow: 0 0 10px rgba(57, 255, 20, 0.7);
        }
        .section-title {
            font-family: 'Cairo', sans-serif;
            font-weight: 700;
            font-size: 1.875rem;
            text-align: center;
            margin-bottom: 1.5rem;
            color: #ffffff; /* White text */
            text-shadow: 0 0 5px #39FF14, 0 0 10px #39FF14; /* Glowing green shadow */
        }
        .calendar-item {
            background-color: rgba(57, 255, 20, 0.1);
            border: 1px solid rgba(57, 255, 20, 0.3);
        }

        /* Elegant Quran Player */
        #quran-player-container {
            background-color: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(57, 255, 20, 0.3);
            border-radius: 1rem;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        #current-surah-name {
            color: #ffffff;
            text-shadow: 0 0 3px #39FF14;
        }
        .quran-surah {
            cursor: pointer;
            padding: 0.75rem;
            border-radius: 0.5rem;
            transition: background-color 0.2s ease;
        }
        .quran-surah:hover {
            background-color: rgba(57, 255, 20, 0.2);
        }
        .quran-surah.playing {
            background-color: rgba(57, 255, 20, 0.3);
            border-left: 4px solid #39FF14;
        }
        .quran-surah.playing .surah-name {
            color: #39FF14;
            font-weight: bold;
        }
        .play-pause-icon {
            color: #39FF14;
            font-size: 1.25rem;
        }

        /* Daily Islamic Message */
        #daily-islamic-message {
            color: #39FF14;
            text-shadow: 0 0 5px rgba(57, 255, 20, 0.7);
        }
        #daily-islamic-message-ref {
            color: #a7f3d0;
            font-style: italic;
        }

        /* Hadith Archive & Box */
        .hadith-archive-item {
            background-color: rgba(255, 255, 255, 0.05);
            border-left: 4px solid #39FF14;
            padding: 1rem;
            border-radius: 0 0.5rem 0.5rem 0;
        }
        .hadith-box {
            border: 1px solid rgba(57, 255, 20, 0.3);
            background-color: rgba(57, 255, 20, 0.05);
            padding: 1.5rem;
            border-radius: 1rem;
        }
        
        /* Highlighted Radio Player */
        #home-radio-audio-player {
            border-radius: 50px;
            box-shadow: 0 0 8px #39FF14, 0 0 12px #39FF14;
            transition: box-shadow 0.3s ease;
        }

        /* General Styles */
        .video-container { position: relative; width: 100%; padding-bottom: 56.25%; height: 0; overflow: hidden; border-radius: 0.75rem; max-width: 960px; margin: auto; }
        .video-container iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #compass { position: relative; width: 256px; height: 256px; background-color: #1f2937; border-radius: 9999px; border: 4px solid #374151; display: flex; align-items: center; justify-content: center; margin: 2rem auto; }
        .direction { position: absolute; font-weight: bold; color: #9ca3af; }
        .direction.north { top: 10px; font-size: 1.5rem; color: #ef4444; }
        .direction.south { bottom: 10px; }
        .direction.east { right: 10px; }
        .direction.west { left: 10px; }
        #hadith-content-home p { font-size: 1.125rem; line-height: 1.75; color: #d1d5db; }
        .calendar-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 1.25rem; }
        .calendar-item:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0, 0, 0, 0.25); }
        .calendar-date { font-family: 'Amiri', serif; font-size: 1.25rem; font-weight: 700; color: #f0fdf4; background-color: #14b8a6; padding: 0.25rem 0.75rem; border-radius: 9999px; display: inline-block; margin-bottom: 0.75rem; }
        .calendar-event-name { font-size: 1.5rem; font-weight: 600; color: #a7f3d0; margin-bottom: 0.5rem; }
        .calendar-event-desc { font-size: 1rem; color: #d1d5db; flex-grow: 1; }
        .gregorian-date { font-size: 0.9rem; color: #9ca3af; margin-top: 1rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 0.75rem; }
    </style>
</head>
<body class="bg-gray-900 text-white">

    <div id="loading-screen" class="fixed inset-0 bg-gray-900 bg-opacity-90 flex flex-col justify-center items-center z-50">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4" style="border-color: #39FF14;"></div>
        <p class="mt-4 text-lg">Finding your location and fetching data...</p>
    </div>

    <div id="main-content" class="min-h-screen container mx-auto p-4 sm:p-6 lg:p-8 opacity-0 transition-opacity duration-1000">
        <!-- Header Section -->
        <header class="text-center mb-6">
            <img id="app-logo" src="https://i.ibb.co/Zp0bgjsS/ART-WORKS-1.png" alt="Ramadhan World Logo" class="w-[200px] h-[200px] mx-auto mb-4 rounded-full shadow-lg object-contain">
            <h1 class="text-4xl sm:text-5xl font-extrabold" style="color: #39FF14;">Ramadhan World</h1>
            <p id="islamic-date" class="text-lg text-gray-300 mt-2">Loading Islamic Date...</p>
            <p id="location" class="text-md text-gray-400 mt-1">Fetching location...</p>
        </header>

        <!-- Navigation -->
        <nav class="flex justify-center gap-2 mb-6 flex-wrap items-center">
            <button onclick="showView('home')" class="nav-button active px-4 py-2 rounded-lg bg-gray-700 transition">Home</button>
            <button onclick="showView('salah')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Salah</button>
            <button onclick="showView('listenQuran')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Quran</button>
            <button onclick="showView('hadith')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Hadith</button>
            <button onclick="showView('tasbeeh')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Tasbeeh</button>
            <button onclick="showView('naat')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Naat</button>
            <button onclick="showView('qibla')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Qibla</button>
            <button onclick="showView('calendar')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Calendar</button>
            <button onclick="showView('settings')" class="nav-button px-4 py-2 rounded-lg bg-gray-700 transition">Settings</button>
        </nav>

        <!-- Main Views -->
        <main>
            <!-- Home View -->
            <div id="home-view">
                <section id="countdown-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h2 id="countdown-heading" class="text-2xl mb-2">Time until <span id="next-prayer-name">...</span></h2>
                        <div id="countdown-timer" class="tracking-wider">00:00:00</div>
                    </div>
                </section>
                
                <section id="home-radio-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-2xl mx-auto text-center">
                        <h3 class="text-xl font-bold mb-4" style="color: #39FF14; text-shadow: 0 0 5px rgba(57, 255, 20, 0.7);">PRESS TO PLAY LIVE RADIO</h3>
                        <audio id="home-radio-audio-player" controls class="w-full"></audio>
                    </div>
                </section>

                <!-- Daily Islamic Message -->
                <section id="daily-message-section" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-3xl mx-auto text-center">
                         <p id="daily-islamic-message" class="text-2xl font-bold mb-2">"Indeed, in the remembrance of Allah do hearts find rest."</p>
                         <p id="daily-islamic-message-ref" class="text-lg">‚Äî Surah Ar-Ra'd (13:28)</p>
                    </div>
                </section>

                <!-- Hadith for Today Section -->
                <section id="hadith-section-home" class="mb-8">
                    <div class="card rounded-2xl p-6 max-w-3xl mx-auto text-center">
                        <div id="hadith-content-home">
                           <!-- Hadith will be loaded here -->
                        </div>
                    </div>
                </section>
            </div>
            
            <!-- Hadith Archive View -->
            <div id="hadith-view" class="hidden">
                <div class="section-card">
                    <h2 class="section-title">üìú Hadith Archive</h2>
                    <div id="hadith-log-list" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2">
                        <!-- Hadith log will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="calendar-view" class="hidden">
                <section id="islamic-calendar-section">
                     <div class="section-card">
                        <h2 class="section-title">üóìÔ∏è Major Islamic Events</h2>
                        <div id="islamic-calendar-grid" class="calendar-grid">
                            <!-- Events will be populated here by JavaScript -->
                        </div>
                    </div>
                </section>
            </div>

            <!-- Qibla View -->
            <div id="qibla-view" class="hidden text-center">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Qibla Compass</h2>
                    <div id="compass">
                        <div id="qibla-line" style="transform-origin: bottom center; transition: transform 0.2s linear; position: absolute; width: 3px; height: 128px; top: 0px; left: 50%;"></div>
                    </div>
                    <p id="qibla-direction" class="mt-4 text-lg text-gray-300">For accurate results, hold your device flat, away from any metals.</p>
                    <p class="text-lg text-yellow-400 mt-4 font-bold">THIS FEATURE IS COMING SOON</p>
                    <p class="text-sm text-gray-400 mt-2">(Accuracy depends on your device's hardware and browser support)</p>
                </div>
            </div>

            <!-- Listen Quran View -->
            <div id="listen-quran-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-4xl mx-auto">
                    <h2 class="section-title">Holy Quran Recitation</h2>
                    <!-- Elegant Player -->
                    <div id="quran-player-container">
                        <h3 id="current-surah-name" class="text-xl font-bold mb-2 text-center">Select a Surah to Play</h3>
                        <audio id="quran-audio-player" controls class="w-full rounded-lg"></audio>
                    </div>
                    <!-- Surah List -->
                    <div id="quran-surah-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[60vh] overflow-y-auto pr-2">
                        <!-- Surahs will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Salah View -->
            <div id="salah-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-2xl mx-auto">
                    <h2 class="text-2xl font-semibold mb-4 text-center">Today's Times</h2>
                    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div id="salah-fajr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Fajr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-sunrise" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Sunrise</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-dhuhr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Dhuhr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-asr" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Asr</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-maghrib" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Maghrib</span><span class="text-xl font-mono">--:--</span></div>
                        <div id="salah-isha" class="prayer-time card rounded-xl p-4 flex justify-between items-center"><span class="font-semibold text-lg">Isha</span><span class="text-xl font-mono">--:--</span></div>
                    </div>
                    <hr class="border-gray-600 my-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div id="salah-sehri" class="card rounded-xl p-4 flex justify-between items-center bg-green-900 border-l-4 border-green-400">
                            <span class="font-semibold text-lg">Sehri End</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                        <div id="salah-iftar" class="card rounded-xl p-4 flex justify-between items-center bg-yellow-800 border-l-4 border-yellow-400">
                            <span class="font-semibold text-lg">Iftar</span>
                            <span class="text-xl font-mono">--:--</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Tasbeeh View -->
            <div id="tasbeeh-view" class="hidden">
                 <div class="card rounded-2xl p-6 max-w-sm mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Tasbeeh Counter</h2>
                    <div id="tasbeeh-counter-display" class="font-mono text-7xl font-bold text-green-400 mb-4">0</div>
                    <button onclick="incrementTasbeeh()" class="w-48 h-48 rounded-full bg-green-500 text-black text-5xl flex items-center justify-center mx-auto shadow-lg transform transition hover:scale-105 active:scale-95"><i class="fas fa-plus"></i></button>
                    <button onclick="resetTasbeeh()" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition">Reset</button>
                </div>
            </div>
            
            <!-- Naat View -->
            <div id="naat-view" class="hidden">
                <div class="card rounded-2xl p-6 mx-auto text-center">
                    <h2 class="text-2xl font-semibold mb-4">Naat Collection</h2>
                    <div class="video-container mb-4">
                        <div id="youtube-player"></div>
                    </div>
                    <div class="flex justify-center gap-4 flex-wrap">
                        <button onclick="previousVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-backward"></i></button>
                        <button id="tv-play-button" onclick="playVideo()" class="text-black font-bold py-2 px-4 rounded-full text-lg" style="background-color: #39FF14;"><i class="fas fa-play"></i></button>
                        <button id="tv-pause-button" onclick="pauseVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg hidden"><i class="fas fa-pause"></i></button>
                        <button onclick="nextVideo()" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-full text-lg"><i class="fas fa-forward"></i></button>
                    </div>
                </div>
            </div>

            <!-- Settings View -->
            <div id="settings-view" class="hidden">
                <div class="card rounded-2xl p-6 max-w-lg mx-auto">
                    <h2 class="text-2xl font-semibold mb-4">Settings</h2>
                    <div class="space-y-4">
                        <div>
                            <h3 class="text-lg font-semibold text-green-400 mb-2">Master Notification Control</h3>
                            <p class="text-sm text-gray-400 mb-2">Enable or disable all prayer time notifications.</p>
                            <button id="settings-notification-toggle" onclick="toggleMasterNotifications()" class="w-full py-2 px-4 rounded-lg transition-colors">Toggle Notifications</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="text-center p-4 text-sm text-gray-600 space-x-4">
          <a href="about.html" class="text-blue-600 underline">About</a>
          <a href="privacy.html" class="text-blue-600 underline">Privacy Policy</a>
          <a href="contact.html" class="text-blue-600 underline">Contact</a>
        </footer>
    </div>

    <div id="settings-saved-message" class="fixed bottom-5 left-1/2 -translate-x-1/2 bg-green-500 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300"></div>
    
    <script src="https://www.youtube.com/iframe_api"></script>

    <script>
        // --- DOM Elements & State ---
        const loadingScreen = document.getElementById('loading-screen');
        const mainContent = document.getElementById('main-content');
        const islamicDateEl = document.getElementById('islamic-date');
        const locationEl = document.getElementById('location');
        const nextPrayerNameEl = document.getElementById('next-prayer-name');
        const countdownTimerEl = document.getElementById('countdown-timer');
        const salahPrayerTimeElements = { Fajr: document.querySelector('#salah-fajr span:last-child'), Sunrise: document.querySelector('#salah-sunrise span:last-child'), Dhuhr: document.querySelector('#salah-dhuhr span:last-child'), Asr: document.querySelector('#salah-asr span:last-child'), Maghrib: document.querySelector('#salah-maghrib span:last-child'), Isha: document.querySelector('#salah-isha span:last-child') };
        const views = { home: document.getElementById('home-view'), qibla: document.getElementById('qibla-view'), listenQuran: document.getElementById('listen-quran-view'), salah: document.getElementById('salah-view'), hadith: document.getElementById('hadith-view'), tasbeeh: document.getElementById('tasbeeh-view'), naat: document.getElementById('naat-view'), calendar: document.getElementById('calendar-view'), settings: document.getElementById('settings-view') };
        const qiblaDirectionEl = document.getElementById('qibla-direction');
        const qiblaLine = document.getElementById('qibla-line');
        const quranSurahList = document.getElementById('quran-surah-list');
        const quranAudioPlayer = document.getElementById('quran-audio-player');
        const currentSurahName = document.getElementById('current-surah-name');
        const homeRadioAudioPlayer = document.getElementById('home-radio-audio-player');
        const settingsSavedMessage = document.getElementById('settings-saved-message');
        const tvPlayButton = document.getElementById('tv-play-button');
        const tvPauseButton = document.getElementById('tv-pause-button');
        const tasbeehCounterDisplay = document.getElementById('tasbeeh-counter-display');
        const hadithContentHome = document.getElementById('hadith-content-home');
        const hadithLogList = document.getElementById('hadith-log-list');
        const dailyIslamicMessageEl = document.getElementById('daily-islamic-message');
        const dailyIslamicMessageRefEl = document.getElementById('daily-islamic-message-ref');
        const settingsNotificationToggle = document.getElementById('settings-notification-toggle');
        
        let tasbeehCount = 0;
        let countdownInterval;
        let qiblaAngle = 0;
        let notificationsEnabled = true;
        let youtubePlayer;
        let quranChapters = [];
        let currentSurahIndex = -1;
        let currentPlayingSurahElement = null;
        let userCoords = null;
        let audioUnlocked = false;

        const NOTIFICATION_STATUS_KEY = 'ramadanAppNotificationStatus';
        const HADITH_LOG_KEY = 'ramadanAppHadithLog';

        const radioStations = [{ name: "Ramadhan World", url: "https://ramadhan786.radioca.st/;" }];
        const islamicEvents = [
            { date: "27 Rajab", name: "Isra and Mi'raj", gregorianDates: { 2025: "Monday, January 27", 2026: "Friday, January 16" }, description: "The Prophet's Ô∑∫ miraculous night journey." },
            { date: "15 Sha‚Äôban", name: "Laylat al-Bara'at", gregorianDates: { 2025: "Friday, February 14", 2026: "Wednesday, February 4" }, description: "The night of forgiveness." },
            { date: "1 Ramadan", name: "Start of Ramadan", gregorianDates: { 2025: "Saturday, March 1", 2026: "Thursday, February 19" }, description: "The beginning of the holy month of fasting." },
            { date: "27 Ramadan", name: "Laylat al-Qadr", gregorianDates: { 2025: "Thursday, March 27", 2026: "Tuesday, March 17" }, description: "The Night of Power, better than a thousand months." },
            { date: "1 Shawwal", name: "Eid al-Fitr", gregorianDates: { 2025: "Sunday, March 30", 2026: "Friday, March 20" }, description: "The festival of breaking the fast." },
            { date: "10 Dhul Hijjah", name: "Eid al-Adha", gregorianDates: { 2025: "Friday, June 6", 2026: "Wednesday, May 27" }, description: "The festival of sacrifice." },
            { date: "1 Muharram", name: "Islamic New Year", gregorianDates: { 2025: "Friday, June 27", 2026: "Wednesday, May 17" }, description: "The start of the Islamic lunar calendar." },
            { date: "10 Muharram", name: "Day of Ashura", gregorianDates: { 2025: "Sunday, July 6", 2026: "Friday, May 26" }, description: "A day of fasting and remembrance." },
            { date: "12 Rabi al-Awwal", name: "Mawlid an-Nabi", gregorianDates: { 2025: "Friday, September 5", 2026: "Tuesday, August 25" }, description: "The birthday of Prophet Muhammad Ô∑∫." }
        ];

        const curatedHadiths = [
            { text: "The Prophet (Ô∑∫) said, 'The best among you are those who have the best manners and character.'", book: "Sahih al-Bukhari", number: "3559" },
            { text: "The Prophet (Ô∑∫) said, 'A Muslim is a brother of another Muslim... Whoever fulfilled the needs of his brother, Allah will fulfill his needs.'", book: "Sahih al-Bukhari", number: "2442" },
            { text: "The Prophet (Ô∑∫) said, 'None of you will have faith till he wishes for his (Muslim) brother what he likes for himself.'", book: "Sahih al-Bukhari", number: "13" },
            { text: "The Prophet (Ô∑∫) said, 'He who is not merciful to others, will not be treated mercifully.'", book: "Sahih al-Bukhari", number: "5997" },
            { text: "The Prophet (Ô∑∫) said, 'Exchange gifts, you will love one another.'", book: "Al-Adab Al-Mufrad", number: "594" },
            { text: "The Prophet (Ô∑∫) said, 'Charity does not decrease wealth.'", book: "Sahih Muslim", number: "2588" }
        ];

        const curatedQuranMessages = [
            { text: "Indeed, in the remembrance of Allah do hearts find rest.", reference: "Surah Ar-Ra'd (13:28)" },
            { text: "And He is with you wherever you are.", reference: "Surah Al-Hadid (57:4)" },
            { text: "So verily, with the hardship, there is relief. Verily, with the hardship, there is relief.", reference: "Surah Ash-Sharh (94:5-6)" },
            { text: "And speak to people good [words].", reference: "Surah Al-Baqarah (2:83)" },
            { text: "And seek help through patience and prayer.", reference: "Surah Al-Baqarah (2:45)" }
        ];

        // --- Core Functions ---
        async function initializeApp() {
            document.body.addEventListener('click', unlockAllAudio, { once: true });
            loadNotificationStatus();
            loadTasbeehCount();
            populateEventCalendar();
            displayDailyHadith();
            populateHadithLogPage();
            displayDailyMessage();
            setupRadioPlayer();
            setInterval(displayDailyHadith, 6 * 60 * 60 * 1000);
            setInterval(displayDailyMessage, 6 * 60 * 60 * 1000);
            await getUserLocation();
            await populateQuranList();
            quranAudioPlayer.addEventListener('ended', playNextSurah);
        }

        function unlockAllAudio() {
            if (audioUnlocked) return;
            // The Quran player is handled by its own direct click event.
            // This global unlocker is for other audio elements like the radio.
            const allAudio = [homeRadioAudioPlayer];
            allAudio.forEach(audio => {
                audio.muted = true;
                const playPromise = audio.play();
                if(playPromise !== undefined){
                    playPromise.then(() => {
                        audio.pause();
                        audio.currentTime = 0;
                        audio.muted = false;
                    }).catch(() => {});
                }
            });
            audioUnlocked = true;
            console.log("Audio contexts unlocked by user interaction.");
        }
        
        function displayDailyMessage() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const messageIndex = dayOfYear % curatedQuranMessages.length;
            const message = curatedQuranMessages[messageIndex];
            dailyIslamicMessageEl.textContent = `"${message.text}"`;
            dailyIslamicMessageRefEl.textContent = `‚Äî ${message.reference}`;
        }
        
        function addHadithToLog(hadithToAdd) {
            const log = JSON.parse(localStorage.getItem(HADITH_LOG_KEY) || '[]');
            const isAlreadyLogged = log.some(item => item.number === hadithToAdd.number);
            if (!isAlreadyLogged) {
                log.unshift(hadithToAdd); // Add to the beginning
                localStorage.setItem(HADITH_LOG_KEY, JSON.stringify(log));
                populateHadithLogPage(); // Refresh the log page
            }
        }

        function displayDailyHadith() {
            const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / (1000 * 60 * 60 * 24));
            const hadithIndex = dayOfYear % curatedHadiths.length;
            const hadith = curatedHadiths[hadithIndex];
            
            hadithContentHome.innerHTML = `
                <div class="hadith-box">
                    <h2 class="section-title mb-4">üìñ Hadith for Today</h2>
                    <p class="font-amiri text-center text-xl">"${hadith.text}"</p>
                    <p class="text-center text-base text-green-300 mt-4">
                        Reference: ${hadith.book} ${hadith.number}
                    </p>
                </div>
            `;
            addHadithToLog(hadith);
        }

        function populateHadithLogPage() {
            const log = JSON.parse(localStorage.getItem(HADITH_LOG_KEY) || '[]');
            if (log.length === 0) {
                hadithLogList.innerHTML = `<p class="text-center text-gray-400">The Hadith archive is empty. Check back tomorrow for a new entry!</p>`;
                return;
            }
            hadithLogList.innerHTML = log.map(hadith => `
                <div class="hadith-archive-item text-center">
                    <p class="font-amiri text-xl">"${hadith.text}"</p>
                    <p class="text-base text-green-300 mt-2">
                        Reference: ${hadith.book} ${hadith.number}
                    </p>
                </div>
            `).join('');
        }

        function populateEventCalendar() {
            const grid = document.querySelector('#calendar-view #islamic-calendar-grid');
            const currentYear = new Date().getFullYear();
            const now = new Date();
            now.setHours(0, 0, 0, 0); 

            const processEventsForYear = (year) => {
                 return islamicEvents.map(event => {
                    const eventDateStr = event.gregorianDates[year];
                    if (!eventDateStr) return null;
                    const eventDate = new Date(`${eventDateStr}, ${year}`);
                    return { ...event, dateObj: eventDate, displayDate: eventDateStr, displayYear: year };
                }).filter(Boolean);
            };

            let allEvents = [
                ...processEventsForYear(currentYear),
                ...processEventsForYear(currentYear + 1)
            ];

            let futureEvents = allEvents.filter(event => event.dateObj >= now);
            futureEvents.sort((a, b) => a.dateObj - b.dateObj);

            if (grid) {
                if (futureEvents.length > 0) {
                    grid.innerHTML = futureEvents.map(event => `
                        <div class="calendar-item" style="transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; flex-direction: column;">
                            <div class="calendar-date">${event.date}</div>
                            <h3 class="calendar-event-name">${event.name}</h3>
                            <p class="calendar-event-desc">${event.description}</p>
                            <div class="gregorian-date">
                                <strong>Expected Gregorian Date (${event.displayYear}):</strong><br>${event.displayDate}
                            </div>
                        </div>
                    `).join('');
                } else {
                    grid.innerHTML = `<p class="text-center col-span-full text-gray-400">No major Islamic events scheduled for the near future.</p>`;
                }
            }
        }
        
        function calculateQiblaDirection(userLat, userLon) {
            const kaabaLat = 21.4225;
            const kaabaLon = 39.8262;
            const dLon = (kaabaLon - userLon) * (Math.PI / 180);
            const lat1 = userLat * (Math.PI / 180);
            const lat2 = kaabaLat * (Math.PI / 180);
            const y = Math.sin(dLon) * Math.cos(lat2);
            const x = Math.cos(lat1) * Math.sin(lat2) - Math.sin(lat1) * Math.cos(lat2) * Math.cos(dLon);
            return (Math.atan2(y, x) * (180 / Math.PI) + 360) % 360;
        }

        function getUserLocation() {
            return new Promise((resolve) => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(async (position) => {
                        userCoords = {
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        };
                        qiblaAngle = calculateQiblaDirection(userCoords.latitude, userCoords.longitude);

                        try {
                            const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${userCoords.latitude}&lon=${userCoords.longitude}`);
                            const data = await response.json();
                            const city = data.address.city || data.address.town || 'Unknown';
                            const country = data.address.country || 'Country';
                            locationEl.textContent = `${city}, ${country}`;
                            const prayerTimes = await getPrayerTimes(city, country);
                            if(prayerTimes) updateCountdown(prayerTimes);
                        } catch (error) {
                            const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                             if(prayerTimes) updateCountdown(prayerTimes);
                        }
                        resolve();
                    }, async () => {
                        locationEl.textContent = "Location denied. Using default times for Karachi.";
                        const prayerTimes = await getPrayerTimes("Karachi", "Pakistan");
                        if(prayerTimes) updateCountdown(prayerTimes);
                        resolve();
                    });
                } else {
                     getPrayerTimes("Karachi", "Pakistan").then(prayerTimes => {
                         if(prayerTimes) updateCountdown(prayerTimes)
                     });
                    resolve();
                }
            });
        }

         async function getPrayerTimes(city, country) {
            try {
                const date = new Date();
                const dateString = `${date.getDate()}-${date.getMonth() + 1}-${date.getFullYear()}`;
                const apiUrl = `https://api.aladhan.com/v1/timingsByCity/${dateString}?city=${city}&country=${country}&method=2`;
                const response = await fetch(apiUrl);
                const data = await response.json();
                if (data.code === 200) {
                    displayPrayerTimes(data.data);
                    return data.data.timings;
                }
                 return null;
            } catch (error) {
                console.error("Error fetching prayer times:", error);
                 return null;
            } finally {
                hideLoading();
            }
        }

        function subtractMinutes(timeStr, minutesToSubtract) {
            const [hours, minutes] = timeStr.split(':').map(Number);
            const time = new Date();
            time.setHours(hours, minutes, 0, 0);
            time.setMinutes(time.getMinutes() - minutesToSubtract);
            return `${padZero(time.getHours())}:${padZero(time.getMinutes())}`;
        }

        function displayPrayerTimes(data) {
            const { timings, date } = data;
            islamicDateEl.textContent = `${date.hijri.weekday.en}, ${date.hijri.day} ${date.hijri.month.en} ${date.hijri.year}`;
            
            Object.keys(salahPrayerTimeElements).forEach(prayer => {
                if (salahPrayerTimeElements[prayer] && timings[prayer]) {
                    salahPrayerTimeElements[prayer].textContent = formatTime(timings[prayer]);
                }
            });

            const sehriTime = subtractMinutes(timings.Fajr, 10);
            const iftarTime = subtractMinutes(timings.Maghrib, 2);
            document.querySelector('#salah-sehri span:last-child').textContent = formatTime(sehriTime);
            document.querySelector('#salah-iftar span:last-child').textContent = formatTime(iftarTime);
        }
        
        function updateCountdown(timings) {
            if (countdownInterval) clearInterval(countdownInterval);
            countdownInterval = setInterval(() => {
                const now = new Date();
                let nextPrayer = findNextPrayer(now, timings);
                
                let prayerTime;
                if (nextPrayer) {
                    prayerTime = new Date(`${now.toDateString()} ${nextPrayer.time}`);
                } else {
                    // After Isha, countdown to next day's Fajr
                    nextPrayer = { name: 'Fajr', time: timings.Fajr };
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    prayerTime = new Date(`${tomorrow.toDateString()} ${nextPrayer.time}`);
                }

                if (nextPrayer.name !== nextPrayerNameEl.textContent) {
                    nextPrayer.triggered = false;
                }
                nextPrayerNameEl.textContent = nextPrayer.name;
                
                const diff = prayerTime.getTime() - now.getTime();
                
                if (diff > 0) {
                    const hours = Math.floor(diff / 3600000);
                    const minutes = Math.floor((diff % 3600000) / 60000);
                    const seconds = Math.floor((diff % 60000) / 1000);
                    countdownTimerEl.textContent = `${padZero(hours)}:${padZero(minutes)}:${padZero(seconds)}`;
                    if (diff <= 1000 && !nextPrayer.triggered) {
                       triggerPrayerNotification(nextPrayer.name);
                       nextPrayer.triggered = true;
                    }
                } else {
                    getUserLocation();
                }
            }, 1000);
        }

        function findNextPrayer(now, timings) {
            for (const prayerName of ['Fajr', 'Dhuhr', 'Asr', 'Maghrib', 'Isha']) {
                if (timings[prayerName]) {
                    const prayerTime = new Date(`${now.toDateString()} ${timings[prayerName]}`);
                    if (prayerTime > now) return { name: prayerName, time: timings[prayerName] };
                }
            }
            return null;
        }

        function showView(viewName) {
            if (viewName !== 'listenQuran') quranAudioPlayer.pause();
            if (viewName !== 'home') homeRadioAudioPlayer.pause();
            if (viewName !== 'naat' && youtubePlayer && typeof youtubePlayer.pauseVideo === 'function') youtubePlayer.pauseVideo();
            
            Object.values(views).forEach(view => view.classList.add('hidden'));
            if (views[viewName]) views[viewName].classList.remove('hidden');
            
            document.querySelectorAll('.nav-button').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-button[onclick="showView('${viewName}')"]`)?.classList.add('active');
            
            if (viewName === 'qibla') startCompass();
            else stopCompass();
        }

        function hideLoading() {
            loadingScreen.style.opacity = '0';
            setTimeout(() => {
                loadingScreen.style.display = 'none';
                mainContent.classList.remove('opacity-0');
            }, 500);
        }

        function startCompass() {
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission().then(permissionState => {
                    if (permissionState === 'granted') window.addEventListener('deviceorientation', handleOrientation);
                }).catch(console.error);
            } else {
                 window.addEventListener('deviceorientation', handleOrientation);
            }
        }
        function stopCompass() { window.removeEventListener('deviceorientation', handleOrientation); }
        function handleOrientation(event) {
            let alpha = event.webkitCompassHeading || event.alpha;
            if (alpha !== null && qiblaLine) {
                qiblaLine.style.transform = `translateX(-50%) rotate(${qiblaAngle - alpha}deg)`;
            }
        }

        async function populateQuranList() {
            try {
                const response = await fetch('https://api.quran.com/api/v4/chapters');
                quranChapters = (await response.json()).chapters;
                quranSurahList.innerHTML = quranChapters.map((surah, index) => `
                    <div id="surah-item-${surah.id}" class="quran-surah flex justify-between items-center" onclick="toggleSurahPlay(${surah.id}, ${index})">
                        <div>
                            <p class="surah-name font-semibold">${surah.id}. ${surah.name_simple}</p>
                            <p class="text-sm text-gray-400">${surah.translated_name.name}</p>
                        </div>
                        <i id="icon-${surah.id}" class="fas fa-play play-pause-icon"></i>
                    </div>`).join('');
            } catch (error) { console.error("Error fetching Surahs:", error); }
        }
        
        async function toggleSurahPlay(surahId, index) {
            const surahElement = document.getElementById(`surah-item-${surahId}`);
            
            if (currentPlayingSurahElement && currentPlayingSurahElement !== surahElement) {
                quranAudioPlayer.pause();
            }

            if (surahElement.classList.contains('playing') && !quranAudioPlayer.paused) {
                quranAudioPlayer.pause();
            } else {
                quranAudioPlayer.volume = 1.0; // Set volume to full
                if (currentSurahIndex === index) {
                    quranAudioPlayer.play();
                } else {
                    try {
                        const response = await fetch(`https://api.quran.com/api/v4/chapter_recitations/7/${surahId}`);
                        const audioData = await response.json();
                        quranAudioPlayer.src = audioData.audio_file.audio_url;
                        currentSurahIndex = index;
                        quranAudioPlayer.play();
                    } catch (error) { console.error("Error fetching Surah audio:", error); }
                }
            }
        }

        quranAudioPlayer.onplay = () => {
            if (currentPlayingSurahElement) {
                currentPlayingSurahElement.classList.remove('playing');
                document.getElementById(`icon-${currentPlayingSurahElement.id.split('-')[2]}`).classList.replace('fa-pause', 'fa-play');
            }
            const surah = quranChapters[currentSurahIndex];
            currentPlayingSurahElement = document.getElementById(`surah-item-${surah.id}`);
            currentPlayingSurahElement.classList.add('playing');
            document.getElementById(`icon-${surah.id}`).classList.replace('fa-play', 'fa-pause');
            currentSurahName.textContent = `${surah.name_simple} (${surah.translated_name.name})`;
        };

        quranAudioPlayer.onpause = () => {
             if (currentPlayingSurahElement) {
                currentPlayingSurahElement.classList.remove('playing');
                document.getElementById(`icon-${currentPlayingSurahElement.id.split('-')[2]}`).classList.replace('fa-pause', 'fa-play');
             }
        };

        function playNextSurah() {
            if (currentSurahIndex !== -1 && currentSurahIndex < quranChapters.length - 1) {
                const nextIndex = currentSurahIndex + 1;
                toggleSurahPlay(quranChapters[nextIndex].id, nextIndex);
            }
        }

        function incrementTasbeeh() { tasbeehCounterDisplay.textContent = ++tasbeehCount; saveTasbeehCount(); }
        function resetTasbeeh() { tasbeehCounterDisplay.textContent = tasbeehCount = 0; saveTasbeehCount(); }
        function saveTasbeehCount() { localStorage.setItem('ramadanTasbeeh', tasbeehCount); }
        function loadTasbeehCount() { tasbeehCount = localStorage.getItem('ramadanTasbeeh') || 0; tasbeehCounterDisplay.textContent = tasbeehCount; }

        function setupRadioPlayer() {
            homeRadioAudioPlayer.src = radioStations[0].url;
            homeRadioAudioPlayer.addEventListener('play', () => {
                homeRadioAudioPlayer.volume = 1.0;
            });
        }
        
        function onYouTubeIframeAPIReady() {
            youtubePlayer = new YT.Player('youtube-player', {
                height: '480', width: '854',
                playerVars: { 'playsinline': 1, 'listType': 'playlist', 'list': 'PL6b_3Yr67_wFpDJfaZLlMEUP6h5EroJi2', 'controls': 0, 'rel': 0 },
                events: { 'onStateChange': onPlayerStateChange }
            });
        }
        function onPlayerStateChange(event) {
            tvPlayButton.classList.toggle('hidden', event.data === YT.PlayerState.PLAYING);
            tvPauseButton.classList.toggle('hidden', event.data !== YT.PlayerState.PLAYING);
        }
        function playVideo() { youtubePlayer.playVideo(); }
        function pauseVideo() { youtubePlayer.pauseVideo(); }
        function nextVideo() { youtubePlayer.nextVideo(); }
        function previousVideo() { youtubePlayer.previousVideo(); }

        // --- Notification & Settings Controls ---
        function updateSettingsNotificationUI() {
            if (notificationsEnabled) {
                settingsNotificationToggle.textContent = 'Notifications are ON (Click to Disable)';
                settingsNotificationToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
                settingsNotificationToggle.classList.add('bg-green-600', 'hover:bg-green-700');
            } else {
                settingsNotificationToggle.textContent = 'Notifications are OFF (Click to Enable)';
                settingsNotificationToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
                settingsNotificationToggle.classList.add('bg-red-600', 'hover:bg-red-700');
            }
        }

        function saveNotificationStatus() {
            localStorage.setItem(NOTIFICATION_STATUS_KEY, notificationsEnabled);
        }

        function loadNotificationStatus() {
            const savedStatus = localStorage.getItem(NOTIFICATION_STATUS_KEY);
            notificationsEnabled = savedStatus === null ? true : (savedStatus === 'true');
            updateSettingsNotificationUI();
        }

        function toggleMasterNotifications() {
            if (Notification.permission === 'denied') {
                showTemporaryMessage('Notifications are blocked by your browser.', true);
                return;
            }
            if (Notification.permission === 'default') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        notificationsEnabled = !notificationsEnabled;
                        saveNotificationStatus();
                        updateSettingsNotificationUI();
                        showTemporaryMessage(`Notifications ${notificationsEnabled ? 'Enabled' : 'Disabled'}`);
                    }
                });
            } else {
                notificationsEnabled = !notificationsEnabled;
                saveNotificationStatus();
                updateSettingsNotificationUI();
                showTemporaryMessage(`Notifications ${notificationsEnabled ? 'Enabled' : 'Disabled'}`);
            }
        }
        
        function triggerPrayerNotification(prayerName) {
            if (!notificationsEnabled) return;
            
            const message = `It's time for ${prayerName} prayer!`;
            if (Notification.permission === "granted") {
                new Notification(message);
            }
        }
        
        function showTemporaryMessage(message, isError = false) {
            settingsSavedMessage.textContent = message;
            settingsSavedMessage.style.backgroundColor = isError ? '#ef4444' : '#10B981';
            settingsSavedMessage.classList.add('opacity-100');
            setTimeout(() => {
                settingsSavedMessage.classList.remove('opacity-100');
            }, 4000);
        }

        function formatTime(time24) {
            if (!time24) return '--:--';
            const [hour, minute] = time24.split(':');
            const h = parseInt(hour, 10);
            const ampm = h >= 12 ? 'PM' : 'AM';
            const h12 = h % 12 || 12;
            return `${padZero(h12)}:${minute} ${ampm}`;
        }
        function padZero(num) { return num < 10 ? '0' + num : String(num); }

        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>